<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Heap Layout Demo</title>
    <script src="echarts.min.js"></script>
    <script src="draw_layout.js"></script>
    <script src="set_table.js"></script>
</head>

<body>
    <div id="chart" style="width: 100%; height: 50vh;"></div>
    <!-- <div id="legend" style="width: 100%; text-align: center">
        <div style="font-size: 20px;">
            <span style="background-color: #FF0000;"> &nbsp;&nbsp;&nbsp; </span>New space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #0000FF;"> &nbsp;&nbsp;&nbsp; </span>Old space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #800000;"> &nbsp;&nbsp;&nbsp; </span>Code space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #00FF00;"> &nbsp;&nbsp;&nbsp; </span>Map space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #800080;"> &nbsp;&nbsp;&nbsp; </span>LO space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #FF00FF;"> &nbsp;&nbsp;&nbsp; </span>Code LO space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #808000;"> &nbsp;&nbsp;&nbsp; </span>New LO space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #008000;"> &nbsp;&nbsp;&nbsp; </span>RO space pages&nbsp;&nbsp;&nbsp;
            <span style="background-color: #FFA500;"> &nbsp;&nbsp;&nbsp; </span>objects&nbsp;&nbsp;&nbsp;
        </div>
    </div> 
-->

    <div style="width: 100%; padding: 50px 0px; text-align:center;">
        <table id="summary table" border="1" style="margin: 0 auto;">
            <tr>
                <td>&nbsp;</td>
                <td>New space</td>
                <td>Old space</td>
                <td>Code space</td>
                <td>Map space</td>
                <td>LO space</td>
                <td>Code LO space</td>
                <td>New LO space</td>
                <td>RO space</td>
            </tr>
            <tr id="space capacity">
                <td>Space capacity</td>
                <td id="new space">0</td>
                <td id="old space">0</td>
                <td id="code space">0</td>
                <td id="map space">0</td>
                <td id="lo space">0</td>
                <td id="code lo space">0</td>
                <td id="new lo space">0</td>
                <td id="ro space">0</td>
            </tr>
            <tr id="object size sum">
                <td>Space obj size sum</td>
                <td id="new space">0</td>
                <td id="old space">0</td>
                <td id="code space">0</td>
                <td id="map space">0</td>
                <td id="lo space">0</td>
                <td id="code lo space">0</td>
                <td id="new lo space">0</td>
                <td id="ro space">0</td>
            </tr>

        </table>
    </div>

    <div class="slideContainer" style="text-align:center">
        <input type="range" style="width: 60%; height: 30px;" min="1" max="1" value="1" class="slider" id="myRange"
            onchange="OnMyRangeChange(this.value)">
    </div>

    <div class="buttonContainer" style="text-align:center">
        <button type="button" style="height: 50px; width: 100px;" onclick="OnPrevClick()">Prev</button>
        <button type="button" style="height: 50px; width: 100px;" onclick="OnNextClick()">Next</button>
    </div>

    <script type="text/javascript">
        var summary_table = document.getElementById("summary table")

        function LoadSnapshot(gc_cnt, is_before_gc) {
            myChart.showLoading();
            var url = "snapshots/heap_dump_" + gc_cnt + "_";
            if (is_before_gc) {
                url += "0.json";
            }
            else {
                url += "1.json";
            }
            var request = new XMLHttpRequest();
            request.open("get", url, true);
            request.send(null);
            request.onload = function () {
                if (request.status == 200) {
                    var json = JSON.parse(request.responseText);
                    drawLayout(json);
                    SetSummaryTable(summary_table, json);
                }
            }
        }

        function OnMyRangeChange(value) {
            var gc_cnt = Math.ceil(value / 2);
            var is_before_gc = value % 2;
            LoadSnapshot(gc_cnt, is_before_gc);
        }

        function OnPrevClick() {
            var silder = document.getElementById('myRange');
            if (silder.vaule === silder.min) {
                return;
            }
            silder.value--;
            OnMyRangeChange(silder.value);
        }

        function OnNextClick() {
            var silder = document.getElementById('myRange');
            if (silder.vaule === silder.max) {
                return;
            }
            silder.value++;
            OnMyRangeChange(silder.value);
        }


    </script>

    <script type="text/javascript">

        var gc_amount = 0;
        var myChart = echarts.init(document.getElementById('chart'), null, { renderer: 'canvas' });
        window.onload = function () {

            var request = new XMLHttpRequest();
            var url = "snapshots/mem_range.log"

            request.open("get", url, true);
            request.send(null);
            request.onload = function () {
                if (request.status == 200) {
                    var addrs = request.responseText.split('\n');
                    addr_min = parseInt(addrs[0], 16);
                    addr_max = parseInt(addrs[1], 16);
                }

                var url = "snapshots/gc_cnt.log"
                request.open("get", url, true);
                request.send(null);
                request.onload = function () {
                    if (request.status == 200) {
                        gc_amount = parseInt(request.responseText);
                        document.getElementById("myRange").max = gc_amount * 2;
                        LoadSnapshot(1, true);
                    }
                }
            }
        }
    </script>
</body>

</html>